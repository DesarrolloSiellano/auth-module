import { CommonModule } from '@angular/common';
import {
  ChangeDetectorRef,
  Component,
  ViewChild,
} from '@angular/core';
import { ListTemplateComponent } from '../../shared/components/list-template/list-template.component';
import { DialogModule } from 'primeng/dialog';
import { PermissionService } from './services/permission.service';
import { FormTemplateComponent } from '../../shared/components/form-template/form-template.component';
import {  MenuItem, MessageService } from 'primeng/api';
import { TableLazyLoadEvent } from 'primeng/table';
import moment from 'moment';
import { DataLoaderService } from '../../shared/services/data-load.service';
import { ExcelExportService } from '../../shared/services/excel-export.service';
import { PERMISSION_FORM } from '../../shared/forms/permission.form';
import { ButtonModule } from 'primeng/button';
import { ConfirmService } from '../../shared/services/confirm-dialog.service';
import { ToastModule } from 'primeng/toast';
import { Permission } from './interfaces/permission.interface';

@Component({
  selector: 'app-permissions',
  standalone: true,
  imports: [
    CommonModule,
    ListTemplateComponent,
    DialogModule,
    FormTemplateComponent,
    ButtonModule,
    ToastModule,
  ],
  templateUrl: './permissions.html',
  styleUrl: './permissions.scss',
  providers: [
    PermissionService,
    MessageService,
    DataLoaderService,
    ExcelExportService,
    ConfirmService,
  ],
})
export class PermissionsComponent {
  @ViewChild(FormTemplateComponent) formComponent?: FormTemplateComponent;

  cols = [
    { field: 'name', header: 'Nombre' },
    { field: 'action', header: 'Acción' },
    { field: 'isActive', header: 'Activo' },
    { field: 'resource', header: 'Recurso' },
    { field: 'description', header: 'Descripción' },
  ];

  toAdd: boolean = true;
  options: boolean = false;
  data: any[] = [];
  totalRecords = 10;

  loading: boolean = false;
  filtersGlobal = true;
  selected!: any;
  items: MenuItem[] = [];
  filterExcel: any[] = [];
  isSearchPopulation: boolean = false;

  //create - update
  isFormVisible: boolean = true;
  titleForm: string = 'Creación de permisos';
  isEditForm: boolean = false;
  initialData!: Permission;
  nameLeader: string = '';
  isDisplayForm: boolean = false;
  form = PERMISSION_FORM;

  constructor(
    private permissionService: PermissionService,
    private cdr: ChangeDetectorRef,
    private dataLoader: DataLoaderService,
    private excelexport: ExcelExportService,
    private confirmService: ConfirmService
  ) {}


  create() {
    this.titleForm = 'Creación de permisos';
    this.isFormVisible = true;
    this.isDisplayForm = true;
    this.isEditForm = false;
  }

  update(selected: any) {
    this.onSelectionChange(selected);
  }
  async delete(selected: any) {
    const isConfirm = await this.confirmService.confirmDelete(
      selected.name,
      'Eliminar permiso',
      'Estas seguro de eliminar el permiso',
      'pi pi-exclamation-triangle',
      'Cancelar',
      'Aceptar',
      'secondary'
    );

    if (!isConfirm) {
      this.confirmService.showMessage(
        'error',
        'Cancelado',
        'El permiso no se ha eliminado correctamente'
      );
    }

    if (isConfirm) {
      this.permissionService.delete(selected._id).subscribe({
        next: (response: any) => {
          if (response.statusCode === 200) {
            this.confirmService.showMessage(
              'success',
              'Eliminación',
              'El permiso se ha eliminado correctamente'
            );
          }
        },
        error: (err) => {
          console.error(err.error);
          if (err.error.statusCode === 400) {
            this.confirmService.showMessage(
              'error',
              'Error al eliminar permiso',
              err.error.message
            );
          }
        },
        complete: () => this.rechargeTable(),
      });
    }
  }

  save() {
    const formValues = this.getFormattedFormValues();
    const request$ = this.isEditForm
      ? this.permissionService.update(this.initialData._id, formValues)
      : this.permissionService.create(formValues);

    request$.subscribe({
      next: (response: any) => {
        if (response.statusCode === 200 || response.statusCode === 201) {
          this.closeDialog();
          this.confirmService.showMessage(
            'info',
            (this.isEditForm ? 'Edición' : 'Creación') + ' ' + 'de permiso',
            'El permiso se ha ' +
              (this.isEditForm ? 'editado' : 'creado') +
              ' correctamente'
          );
          this.rechargeTable();
        }
      },
      error: (err) => {
        console.error(err.error);
        if (err.error.statusCode === 400) {
          this.confirmService.showMessage(
            'error',
            'Error al ' + (this.isEditForm ? 'editar' : 'crear') + ' permiso',
            err.error.message
          );
        }
      },
      complete: () => this.closeDialog(),
    });
  }

  recharge(): void {
    this.rechargeTable();
  }

  load(event?: TableLazyLoadEvent) {
    this.loading = true;
    this.dataLoader
      .loadData(
        this.permissionService.findByPage.bind(this.permissionService),
        event
      )
      .subscribe((response) => {
        const result = this.dataLoader.handleResponse(response);
        setTimeout(() => {}, 1500);
        if (result.ok) {
          this.totalRecords = result.totalResults;
          this.data = result.data;
          this.loading = false;
        } else {
          this.loading = false;
        }
      });
    this.cdr.detectChanges();
  }

  rechargeTable(): void {
    this.loading = true;
    this.dataLoader
      .loadData(
        this.permissionService.findByPage.bind(this.permissionService),
        {
          first: 0,
          rows: 100,
          globalFilter: '',
          filters: {},
        }
      )
      .subscribe((response) => {
        const result = this.dataLoader.handleResponse(response);
        if (result.ok) {
          this.totalRecords = result.totalResults;
          this.data = result.data;
          this.loading = false;
        } else {
          this.loading = false;
        }
      });
    this.cdr.detectChanges();
  }

  queryDate(event: any): void {
    this.loading = true;
    this.filtersGlobal = false;
    this.permissionService
      .findByDate(
        moment(event.initial).format('YYYY-MM-DD'),
        moment(event.final).format('YYYY-MM-DD')
      )
      .subscribe((data: any) => {
        const result = this.dataLoader.handleResponse(data);
        if (result.ok) {
          this.totalRecords = result.totalResults;
          this.data = result.data;
          this.loading = false;
        } else {
          this.loading = false;
        }
      });
  }

  exportAsXLSX(): void {
    this.excelexport.exportAsExcelFile(this.data, 'totalLeaders');
  }

  onSelectionChange(selectedItem: any) {
    if (selectedItem) {
      this.isEditForm = true;
      this.titleForm = 'Edición de permisos';
      this.isFormVisible = true;
      this.isDisplayForm = true;

      this.initialData = {
        ...this.initialData,
        ...selectedItem,
      };
    }
  }

  private getFormattedFormValues(): any {
    const values = { ...this.formComponent?.formGroup?.value };
    return values;
  }

  closeDialog() {
    this.isDisplayForm = false;
    this.isFormVisible = false;
    this.formComponent?.reset();
  }
}
